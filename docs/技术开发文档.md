# HBSY VideoGrabber Pro æŠ€æœ¯å¼€å‘æ–‡æ¡£

> è‹±æ–‡åç§°ï¼šHBSY VideoGrabber Pro  
> ä¸­æ–‡åç§°ï¼šæˆ·éƒ¨å°šèµ¢æ™ºèƒ½è§†é¢‘ä¸‹è½½

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
åŸºäºå¯¹ Chrome å•†åº—å‰ 5 æ¬¾è§†é¢‘ä¸‹è½½æ‰©å±•çš„æµ‹è¯•åˆ†æï¼Œå‘ç°ä»¥ä¸‹å…±åŒç—›ç‚¹ï¼š
- ç¼ºå°‘æ ¼å¼/æ¸…æ™°åº¦é€‰æ‹©åŠŸèƒ½
- ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- ç•Œé¢è®¾è®¡é™ˆæ—§
- éƒ¨åˆ†éœ€è¦æ³¨å†Œæˆ–æ”¶é›†ç”¨æˆ·æ•°æ®

### 1.2 äº§å“å®šä½
æ‰“é€ ä¸€æ¬¾**å…è´¹ã€ç¾è§‚ã€åŠŸèƒ½å®Œå–„**çš„è§†é¢‘ä¸‹è½½æ‰©å±•ï¼Œè§£å†³ç°æœ‰äº§å“çš„æ ¸å¿ƒç—›ç‚¹ã€‚

### 1.3 å‘½åç†ç”±
**HBSY VideoGrabber Pro** (æˆ·éƒ¨å°šèµ¢æ™ºèƒ½è§†é¢‘ä¸‹è½½)
- "HBSY" - æˆ·éƒ¨å°šèµ¢å“ç‰Œæ ‡è¯†
- "VideoGrabber" - è§†é¢‘æŠ“å–å™¨ï¼Œç®€æ´æœ‰åŠ›
- "Pro" - ä½“ç°ä¸“ä¸šæ€§

---

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | æè¿° |
|------|--------|------|
| è§†é¢‘æ£€æµ‹ | P0 | è‡ªåŠ¨æ£€æµ‹é¡µé¢ä¸­çš„ video æ ‡ç­¾å’Œåª’ä½“æµ |
| æ¸…æ™°åº¦é€‰æ‹© | P0 | æ”¯æŒå¤šç§åˆ†è¾¨ç‡é€‰æ‹© |
| æ ¼å¼é€‰æ‹© | P0 | æ”¯æŒ MP4/WebM/MP3 å¯¼å‡º |
| æ–­ç‚¹ç»­ä¼  | P1 | ä½¿ç”¨ Range è¯·æ±‚å®ç°åˆ†ç‰‡ä¸‹è½½ |
| å¤šçº¿ç¨‹ä¸‹è½½ | P1 | å¹¶è¡Œä¸‹è½½æå‡é€Ÿåº¦ |
| æ‰¹é‡ä¸‹è½½ | P2 | ä¸€é”®ä¸‹è½½é¡µé¢æ‰€æœ‰è§†é¢‘ |
| ä¸‹è½½å†å² | P2 | è®°å½•ä¸‹è½½å†å²ä¾¿äºç®¡ç† |

### 2.2 ç•Œé¢éœ€æ±‚
- ç°ä»£åŒ–æ‰å¹³è®¾è®¡
- æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
- ä¸‹è½½è¿›åº¦å¯è§†åŒ–
- å“åº”å¼å¼¹çª—å¸ƒå±€

---

## 3. æŠ€æœ¯æ¶æ„

### 3.1 æ•´ä½“æ¶æ„

```
VideoGrabber/
â”œâ”€â”€ manifest.json          # æ‰©å±•é…ç½®æ–‡ä»¶ (Manifest V3)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background/        # Service Worker
â”‚   â”‚   â””â”€â”€ index.ts       # åå°è„šæœ¬ï¼Œå¤„ç†ä¸‹è½½é€»è¾‘
â”‚   â”œâ”€â”€ content/           # Content Script
â”‚   â”‚   â””â”€â”€ detector.ts    # è§†é¢‘æ£€æµ‹è„šæœ¬
â”‚   â”œâ”€â”€ popup/             # å¼¹çª—ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ App.tsx        # React ä¸»ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ components/    # UI ç»„ä»¶
â”‚   â”‚   â””â”€â”€ index.html     # å¼¹çª—å…¥å£
â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ downloader.ts  # ä¸‹è½½æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ parser.ts      # è§†é¢‘è§£æå™¨
â”‚   â”‚   â””â”€â”€ storage.ts     # å­˜å‚¨ç®¡ç†
â”‚   â””â”€â”€ types/             # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ public/
â”‚   â””â”€â”€ icons/             # æ‰©å±•å›¾æ ‡
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ vite.config.ts         # æ„å»ºé…ç½®
```

### 3.2 æŠ€æœ¯é€‰å‹

| æŠ€æœ¯ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| æ‰©å±•è§„èŒƒ | Manifest V3 | Chrome æœ€æ–°æ ‡å‡†ï¼Œå®‰å…¨æ€§æ›´é«˜ |
| è¯­è¨€ | TypeScript | ç±»å‹å®‰å…¨ï¼Œæå‡ä»£ç è´¨é‡ |
| UI æ¡†æ¶ | React 18 | ç»„ä»¶åŒ–å¼€å‘ï¼Œç”Ÿæ€ä¸°å¯Œ |
| æ ·å¼ | Tailwind CSS | å¿«é€Ÿå¼€å‘ï¼Œä½“ç§¯å° |
| æ„å»ºå·¥å…· | Vite | å¿«é€Ÿæ„å»ºï¼ŒHMR æ”¯æŒ |
| çŠ¶æ€ç®¡ç† | Zustand | è½»é‡çº§ï¼Œé€‚åˆæ‰©å±•å¼€å‘ |

---

## 4. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 4.1 è§†é¢‘æ£€æµ‹æ¨¡å— (Content Script)

```typescript
// content/detector.ts
interface VideoInfo {
  id: string;
  url: string;
  title: string;
  duration: number;
  qualities: Quality[];
  thumbnail?: string;
  type: 'video' | 'blob' | 'hls' | 'm3u8';
}

interface Quality {
  label: string;      // "1080p", "720p"
  resolution: string; // "1920x1080"
  bitrate?: number;
  url: string;
}

class VideoDetector {
  private videos: Map<string, VideoInfo> = new Map();
  
  // æ£€æµ‹ <video> æ ‡ç­¾
  detectVideoElements(): void {
    const videoElements = document.querySelectorAll('video');
    videoElements.forEach(video => {
      if (video.src) {
        this.addVideo(video.src, 'video');
      }
      // æ£€æµ‹ <source> å­å…ƒç´ 
      video.querySelectorAll('source').forEach(source => {
        if (source.src) {
          this.addVideo(source.src, 'video');
        }
      });
    });
  }
  
  // æ‹¦æˆªç½‘ç»œè¯·æ±‚æ£€æµ‹åª’ä½“æµ
  interceptMediaRequests(): void {
    // ä½¿ç”¨ PerformanceObserver ç›‘å¬èµ„æºåŠ è½½
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (this.isMediaUrl(entry.name)) {
          this.addVideo(entry.name, this.detectType(entry.name));
        }
      });
    });
    observer.observe({ entryTypes: ['resource'] });
  }
  
  private isMediaUrl(url: string): boolean {
    const mediaExtensions = ['.mp4', '.webm', '.m3u8', '.mpd'];
    return mediaExtensions.some(ext => url.includes(ext));
  }
}
```

### 4.2 ä¸‹è½½æ ¸å¿ƒæ¨¡å— (Background Service Worker)

```typescript
// background/downloader.ts
interface DownloadTask {
  id: string;
  url: string;
  filename: string;
  totalSize: number;
  downloadedSize: number;
  status: 'pending' | 'downloading' | 'paused' | 'completed' | 'error';
  chunks: Chunk[];
  speed: number;
  progress: number;
}

interface Chunk {
  start: number;
  end: number;
  downloaded: number;
  status: 'pending' | 'downloading' | 'completed';
}

class DownloadManager {
  private tasks: Map<string, DownloadTask> = new Map();
  private maxConcurrent = 3;  // æœ€å¤§å¹¶å‘æ•°
  private chunkSize = 1024 * 1024 * 2; // 2MB åˆ†ç‰‡
  
  // åˆ›å»ºä¸‹è½½ä»»åŠ¡
  async createTask(video: VideoInfo, quality: Quality): Promise<string> {
    const taskId = crypto.randomUUID();
    const totalSize = await this.getFileSize(quality.url);
    
    const task: DownloadTask = {
      id: taskId,
      url: quality.url,
      filename: `${video.title}_${quality.label}.mp4`,
      totalSize,
      downloadedSize: 0,
      status: 'pending',
      chunks: this.createChunks(totalSize),
      speed: 0,
      progress: 0
    };
    
    this.tasks.set(taskId, task);
    await this.saveTask(task);
    return taskId;
  }
  
  // åˆ†ç‰‡ä¸‹è½½å®ç°æ–­ç‚¹ç»­ä¼ 
  private createChunks(totalSize: number): Chunk[] {
    const chunks: Chunk[] = [];
    let start = 0;
    
    while (start < totalSize) {
      const end = Math.min(start + this.chunkSize - 1, totalSize - 1);
      chunks.push({ start, end, downloaded: 0, status: 'pending' });
      start = end + 1;
    }
    
    return chunks;
  }
  
  // å¤šçº¿ç¨‹ä¸‹è½½
  async startDownload(taskId: string): Promise<void> {
    const task = this.tasks.get(taskId);
    if (!task) return;
    
    task.status = 'downloading';
    const pendingChunks = task.chunks.filter(c => c.status !== 'completed');
    
    // å¹¶è¡Œä¸‹è½½å¤šä¸ªåˆ†ç‰‡
    const downloadPromises = pendingChunks
      .slice(0, this.maxConcurrent)
      .map(chunk => this.downloadChunk(task, chunk));
    
    await Promise.all(downloadPromises);
  }
  
  // ä¸‹è½½å•ä¸ªåˆ†ç‰‡ (æ”¯æŒ Range è¯·æ±‚)
  private async downloadChunk(task: DownloadTask, chunk: Chunk): Promise<void> {
    const response = await fetch(task.url, {
      headers: {
        'Range': `bytes=${chunk.start + chunk.downloaded}-${chunk.end}`
      }
    });
    
    const reader = response.body?.getReader();
    if (!reader) return;
    
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      chunk.downloaded += value.length;
      task.downloadedSize += value.length;
      task.progress = (task.downloadedSize / task.totalSize) * 100;
      
      // ä¿å­˜åˆ†ç‰‡æ•°æ®åˆ° IndexedDB
      await this.saveChunkData(task.id, chunk, value);
      
      // é€šçŸ¥ UI æ›´æ–°è¿›åº¦
      this.notifyProgress(task);
    }
    
    chunk.status = 'completed';
  }
  
  // æš‚åœä¸‹è½½
  pauseDownload(taskId: string): void {
    const task = this.tasks.get(taskId);
    if (task) {
      task.status = 'paused';
      this.saveTask(task);
    }
  }
  
  // æ¢å¤ä¸‹è½½ (æ–­ç‚¹ç»­ä¼ )
  async resumeDownload(taskId: string): Promise<void> {
    const task = await this.loadTask(taskId);
    if (task) {
      this.tasks.set(taskId, task);
      await this.startDownload(taskId);
    }
  }
}
```

### 4.3 å­˜å‚¨æ¨¡å—

```typescript
// utils/storage.ts
class StorageManager {
  private db: IDBDatabase | null = null;
  
  async init(): Promise<void> {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('VideoGrabberDB', 1);
      
      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result;
        
        // ä¸‹è½½ä»»åŠ¡å­˜å‚¨
        if (!db.objectStoreNames.contains('tasks')) {
          db.createObjectStore('tasks', { keyPath: 'id' });
        }
        
        // åˆ†ç‰‡æ•°æ®å­˜å‚¨
        if (!db.objectStoreNames.contains('chunks')) {
          const store = db.createObjectStore('chunks', { keyPath: ['taskId', 'index'] });
          store.createIndex('taskId', 'taskId');
        }
        
        // ä¸‹è½½å†å²
        if (!db.objectStoreNames.contains('history')) {
          const store = db.createObjectStore('history', { keyPath: 'id' });
          store.createIndex('date', 'completedAt');
        }
      };
      
      request.onsuccess = () => {
        this.db = request.result;
        resolve();
      };
      
      request.onerror = () => reject(request.error);
    });
  }
  
  // ä¿å­˜ä¸‹è½½ä»»åŠ¡çŠ¶æ€ (ç”¨äºæ–­ç‚¹ç»­ä¼ )
  async saveTask(task: DownloadTask): Promise<void> {
    const tx = this.db!.transaction('tasks', 'readwrite');
    await tx.objectStore('tasks').put(task);
  }
  
  // æ¢å¤ä¸‹è½½ä»»åŠ¡
  async loadTask(taskId: string): Promise<DownloadTask | null> {
    const tx = this.db!.transaction('tasks', 'readonly');
    return tx.objectStore('tasks').get(taskId);
  }
}
```

---

## 5. UI è®¾è®¡

### 5.1 å¼¹çª—ç•Œé¢ç»„ä»¶ç»“æ„

```typescript
// popup/App.tsx
const App: React.FC = () => {
  return (
    <div className="w-[400px] min-h-[300px] bg-gray-900 text-white">
      <Header />
      <VideoList />
      <DownloadQueue />
      <Footer />
    </div>
  );
};

// è§†é¢‘åˆ—è¡¨ç»„ä»¶
const VideoList: React.FC = () => {
  const videos = useVideoStore(state => state.videos);
  
  return (
    <div className="p-4 space-y-3">
      {videos.length === 0 ? (
        <EmptyState message="æœªæ£€æµ‹åˆ°è§†é¢‘" />
      ) : (
        videos.map(video => (
          <VideoCard key={video.id} video={video} />
        ))
      )}
    </div>
  );
};

// è§†é¢‘å¡ç‰‡ç»„ä»¶
const VideoCard: React.FC<{ video: VideoInfo }> = ({ video }) => {
  const [selectedQuality, setSelectedQuality] = useState(video.qualities[0]);
  
  return (
    <div className="bg-gray-800 rounded-lg p-3 hover:bg-gray-750 transition">
      <div className="flex gap-3">
        {video.thumbnail && (
          <img src={video.thumbnail} className="w-24 h-16 rounded object-cover" />
        )}
        <div className="flex-1">
          <h3 className="font-medium text-sm truncate">{video.title}</h3>
          <p className="text-xs text-gray-400">{formatDuration(video.duration)}</p>
          
          {/* æ¸…æ™°åº¦é€‰æ‹© */}
          <QualitySelector 
            qualities={video.qualities}
            selected={selectedQuality}
            onChange={setSelectedQuality}
          />
        </div>
        
        {/* ä¸‹è½½æŒ‰é’® */}
        <DownloadButton video={video} quality={selectedQuality} />
      </div>
    </div>
  );
};
```

### 5.2 è®¾è®¡è§„èŒƒ

```css
/* é¢œè‰²ç³»ç»Ÿ */
:root {
  --primary: #6366f1;      /* ä¸»è‰²è°ƒ - é›è“ */
  --primary-hover: #4f46e5;
  --success: #22c55e;      /* æˆåŠŸ - ç»¿è‰² */
  --warning: #f59e0b;      /* è­¦å‘Š - æ©™è‰² */
  --error: #ef4444;        /* é”™è¯¯ - çº¢è‰² */
  --bg-dark: #111827;      /* æ·±è‰²èƒŒæ™¯ */
  --bg-card: #1f2937;      /* å¡ç‰‡èƒŒæ™¯ */
  --text-primary: #f9fafb;
  --text-secondary: #9ca3af;
}

/* åœ†è§’è§„èŒƒ */
--radius-sm: 4px;
--radius-md: 8px;
--radius-lg: 12px;

/* é—´è·è§„èŒƒ */
--spacing-xs: 4px;
--spacing-sm: 8px;
--spacing-md: 16px;
--spacing-lg: 24px;
```

---

## 6. Manifest é…ç½®

```json
{
  "manifest_version": 3,
  "name": "VideoGrabber Pro",
  "version": "1.0.0",
  "description": "æ™ºèƒ½è§†é¢‘ä¸‹è½½æ‰©å±• - æ”¯æŒå¤šæ¸…æ™°åº¦ã€æ–­ç‚¹ç»­ä¼ ã€å¤šçº¿ç¨‹åŠ é€Ÿ",
  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  },
  "action": {
    "default_popup": "popup/index.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png"
    }
  },
  "background": {
    "service_worker": "background/index.js",
    "type": "module"
  },
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content/detector.js"],
      "run_at": "document_idle"
    }
  ],
  "permissions": [
    "storage",
    "downloads",
    "activeTab",
    "webRequest"
  ],
  "host_permissions": [
    "<all_urls>"
  ]
}
```

---

## 7. å¼€å‘è®¡åˆ’

### 7.1 é‡Œç¨‹ç¢‘

| é˜¶æ®µ | æ—¶é—´ | ç›®æ ‡ | çŠ¶æ€ |
|------|------|------|------|
| M1 | ç¬¬1-2å‘¨ | åŸºç¡€æ¡†æ¶æ­å»ºï¼Œè§†é¢‘æ£€æµ‹åŠŸèƒ½ | âœ… å·²å®Œæˆ |
| M2 | ç¬¬3-4å‘¨ | ä¸‹è½½æ ¸å¿ƒåŠŸèƒ½ï¼Œæ¸…æ™°åº¦é€‰æ‹© | âœ… å·²å®Œæˆ |
| M3 | ç¬¬5-6å‘¨ | æ–­ç‚¹ç»­ä¼ ï¼Œå¤šçº¿ç¨‹ä¸‹è½½ | ğŸ”„ è¿›è¡Œä¸­ |
| M4 | ç¬¬7-8å‘¨ | UI ä¼˜åŒ–ï¼Œæµ‹è¯•å‘å¸ƒ | â³ å¾…å¼€å§‹ |

### 7.2 å½“å‰è¿›åº¦ (2024-12-11 æ›´æ–°)

**å·²å®ŒæˆåŠŸèƒ½ï¼š**
- âœ… é¡¹ç›®åŸºç¡€æ¶æ„ (Vite + React + TypeScript + Tailwind)
- âœ… Manifest V3 é…ç½®
- âœ… è§†é¢‘æ£€æµ‹å™¨ (Content Script)
- âœ… ä¸‹è½½ç®¡ç†å™¨ (Background Service Worker)
- âœ… Popup UI ç•Œé¢ (è§†é¢‘åˆ—è¡¨ã€ä¸‹è½½åˆ—è¡¨ã€è¿›åº¦æ˜¾ç¤º)
- âœ… æ¸…æ™°åº¦é€‰æ‹©åŠŸèƒ½
- âœ… çŠ¶æ€ç®¡ç† (Zustand)
- âœ… å­˜å‚¨æ¨¡å— (IndexedDB)
- âœ… å·¥å…·å‡½æ•° (æ ¼å¼åŒ–ã€è§£æ)
- âœ… æ‰©å±•å›¾æ ‡ç”Ÿæˆ

**å¾…å®ŒæˆåŠŸèƒ½ï¼š**
- â³ æ–­ç‚¹ç»­ä¼ å®Œå–„
- â³ å¤šçº¿ç¨‹ä¸‹è½½ä¼˜åŒ–
- â³ HLS/M3U8 æµè§£æ
- â³ æ‰¹é‡ä¸‹è½½
- â³ ä¸‹è½½å†å²è®°å½•
- â³ è®¾ç½®é¢æ¿
- â³ æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢

### 7.2 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | åº”å¯¹æ–¹æ¡ˆ |
|------|------|----------|
| è·¨åŸŸé™åˆ¶ | éƒ¨åˆ†è§†é¢‘æ— æ³•ä¸‹è½½ | ä½¿ç”¨ background fetch |
| HLS/DASH æµ | éœ€è¦ç‰¹æ®Šå¤„ç† | é›†æˆ hls.js è§£æ |
| å¤§æ–‡ä»¶å­˜å‚¨ | IndexedDB é™åˆ¶ | åˆ†ç‰‡å­˜å‚¨ + åŠæ—¶æ¸…ç† |

---

## 8. ç«å“å¯¹æ¯”

| åŠŸèƒ½ | HBSY VideoGrabber Pro | Video Downloader Professional | Video DownloadHelper |
|------|------------------|------------------------------|---------------------|
| æ¸…æ™°åº¦é€‰æ‹© | âœ… | âŒ | âŒ |
| æ ¼å¼é€‰æ‹© | âœ… | âŒ | âš ï¸ æœ‰é™ |
| æ–­ç‚¹ç»­ä¼  | âœ… | âŒ | âŒ |
| å¤šçº¿ç¨‹ä¸‹è½½ | âœ… | âŒ | âŒ |
| ç°ä»£åŒ– UI | âœ… | âŒ | âŒ |
| æ— éœ€æ³¨å†Œ | âœ… | âœ… | âœ… |
| éšç§ä¿æŠ¤ | âœ… | âš ï¸ | âš ï¸ |
