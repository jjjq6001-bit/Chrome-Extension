# HBSY VideoGrabber Pro - è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ (AI å¢å¼ºç‰ˆ)
# 
# æ­¤ç‰ˆæœ¬ä½¿ç”¨ OpenAI API è‡ªåŠ¨ç”Ÿæˆæ›´ä¸“ä¸šçš„ Release Notes
# 
# éœ€è¦è®¾ç½® GitHub Secret:
#   - OPENAI_API_KEY: ä½ çš„ OpenAI API Key
#
# å¦‚æœä¸æƒ³ä½¿ç”¨ AIï¼Œè¯·ä½¿ç”¨ release.yml

name: ğŸš€ Release (AI Enhanced)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  release:
    name: ğŸ“¦ Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build extension
        run: npm run build

      - name: ğŸ“¦ Run release script
        run: python build_release.py

      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Get commit log
        id: commits
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" --no-merges -20)
          else
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges)
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$COMMITS" > commits.txt
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      # AI ç”Ÿæˆ Release Notes (å¯é€‰)
      - name: ğŸ¤– Generate AI Release Notes
        id: ai_notes
        if: ${{ env.OPENAI_API_KEY != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          pip install openai
          
          python << 'EOF'
          import os
          import openai
          
          # è¯»å– commit log
          with open('commits.txt', 'r') as f:
              commits = f.read()
          
          version = os.environ.get('VERSION', '1.0.0')
          
          prompt = f"""Based on the following git commit messages, generate a professional release note for HBSY VideoGrabber Pro v{version}.

          Commit messages:
          {commits}

          Please generate release notes in the following format (bilingual Chinese and English):

          ## âœ¨ æ–°åŠŸèƒ½ / New Features
          - [List new features]

          ## ğŸ”§ ä¼˜åŒ– / Improvements  
          - [List improvements]

          ## ğŸ› ä¿®å¤ / Bug Fixes
          - [List bug fixes]

          Keep it concise and professional. If a category has no items, omit it."""

          try:
              client = openai.OpenAI()
              response = client.chat.completions.create(
                  model="gpt-3.5-turbo",
                  messages=[
                      {"role": "system", "content": "You are a helpful assistant that generates professional software release notes."},
                      {"role": "user", "content": prompt}
                  ],
                  max_tokens=1000,
                  temperature=0.7
              )
              
              ai_notes = response.choices[0].message.content
              
              with open('ai_notes.md', 'w') as f:
                  f.write(ai_notes)
              
              print("AI release notes generated successfully")
              
          except Exception as e:
              print(f"AI generation failed: {e}")
              # å¦‚æœ AI å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ ¼å¼
              with open('ai_notes.md', 'w') as f:
                  f.write(f"### æ›´æ–°å†…å®¹ / Changes\n\n{commits}")
          EOF
        continue-on-error: true

      - name: ğŸ“ Generate Final Release Notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG="${{ steps.commits.outputs.prev_tag }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ AI ç”Ÿæˆçš„å†…å®¹
          if [ -f "ai_notes.md" ]; then
            AI_CONTENT=$(cat ai_notes.md)
          else
            AI_CONTENT=$(cat commits.txt | sed 's/^/- /')
          fi
          
          cat << EOF > release_notes.md
          ## ğŸ‰ HBSY VideoGrabber Pro v${VERSION}
          
          > HBSYæ™ºèƒ½è§†é¢‘ä¸‹è½½ - ä¸“ä¸šçš„è§†é¢‘ä¸‹è½½æ‰©å±•
          
          ### ğŸ“¥ ä¸‹è½½ / Download
          
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | \`HBSY_VideoGrabber_Pro_v${VERSION}_Install.zip\` | ğŸ“¦ å®‰è£…åŒ… (ç›´æ¥ä½¿ç”¨) |
          | \`HBSY_VideoGrabber_Pro_v${VERSION}_Source.zip\` | ğŸ“ æºç åŒ… (å¼€å‘è€…) |
          
          ### ğŸ“¦ å®‰è£…è¯´æ˜ / Installation
          
          1. ä¸‹è½½ \`Install.zip\` å¹¶è§£å‹
          2. æ‰“å¼€ Chromeï¼Œè®¿é—® \`chrome://extensions/\`
          3. å¼€å¯ã€Œå¼€å‘è€…æ¨¡å¼ã€
          4. ç‚¹å‡»ã€ŒåŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºã€
          5. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          
          ---
          
          ${AI_CONTENT}
          
          ---
          
          ### ğŸ”— ç›¸å…³é“¾æ¥ / Links
          
          - ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
          - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          - ğŸ“œ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ steps.version.outputs.tag }})
          EOF

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "ğŸ‰ HBSY VideoGrabber Pro v${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, 'alpha') || contains(steps.version.outputs.tag, 'beta') }}
          files: |
            release/HBSY_VideoGrabber_Pro_v${{ steps.version.outputs.version }}_Install.zip
            release/HBSY_VideoGrabber_Pro_v${{ steps.version.outputs.version }}_Source.zip
            release/release_note_zh.txt
            release/release_note_en.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Summary
        run: |
          echo "ğŸ‰ Release v${{ steps.version.outputs.version }} published!"
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
