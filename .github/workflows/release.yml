# HBSY VideoGrabber Pro - è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# 
# è§¦å‘æ¡ä»¶: æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾ (å¦‚ v1.0.0)
# 
# ä½¿ç”¨æ–¹æ³•:
#   git tag v1.0.0
#   git push --tags
#
# å·¥ä½œæµç¨‹:
#   1. æ£€å‡ºä»£ç 
#   2. è®¾ç½® Node.js å’Œ Python ç¯å¢ƒ
#   3. æ„å»ºæ‰©å±• (npm run build)
#   4. è¿è¡Œæ‰“åŒ…è„šæœ¬ (build_release.py)
#   5. ç”Ÿæˆ Release Notes (åŸºäº commit log)
#   6. åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ–‡ä»¶

name: ğŸš€ Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰

# è®¾ç½®æƒé™
permissions:
  contents: write

jobs:
  release:
    name: ğŸ“¦ Build and Release
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 4. å®‰è£…ä¾èµ–
      - name: ğŸ“š Install dependencies
        run: npm ci

      # 5. æ„å»ºæ‰©å±•
      - name: ğŸ”¨ Build extension
        run: npm run build

      # 6. è¿è¡Œæ‰“åŒ…è„šæœ¬
      - name: ğŸ“¦ Run release script
        run: python build_release.py

      # 7. è·å–ç‰ˆæœ¬å·
      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # 8. ç”Ÿæˆ Release Notes (åŸºäº commit log)
      - name: ğŸ“ Generate Release Notes
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œè·å–æ‰€æœ‰æäº¤
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          else
            # è·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # ç”Ÿæˆ Release Notes
          cat << EOF > release_notes.md
          ## ğŸ‰ HBSY VideoGrabber Pro v${{ steps.version.outputs.version }}
          
          ### ğŸ“¥ ä¸‹è½½ / Download
          
          | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|
          | \`HBSY_VideoGrabber_Pro_v${{ steps.version.outputs.version }}_Install.zip\` | å®‰è£…åŒ… (Install Package) |
          | \`HBSY_VideoGrabber_Pro_v${{ steps.version.outputs.version }}_Source.zip\` | æºç åŒ… (Source Code) |
          
          ### ğŸ“¦ å®‰è£…è¯´æ˜ / Installation
          
          1. ä¸‹è½½ \`Install.zip\` å¹¶è§£å‹
          2. æ‰“å¼€ Chromeï¼Œè®¿é—® \`chrome://extensions/\`
          3. å¼€å¯ã€Œå¼€å‘è€…æ¨¡å¼ã€
          4. ç‚¹å‡»ã€ŒåŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºã€
          5. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹ / Changelog
          
          ${COMMITS}
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ steps.version.outputs.tag }}
          EOF
          
          echo "Generated release notes"

      # 9. åˆ›å»º GitHub Release
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "ğŸ‰ HBSY VideoGrabber Pro v${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            release/HBSY_VideoGrabber_Pro_v${{ steps.version.outputs.version }}_Install.zip
            release/HBSY_VideoGrabber_Pro_v${{ steps.version.outputs.version }}_Source.zip
            release/release_note_zh.txt
            release/release_note_en.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 10. è¾“å‡ºç»“æœ
      - name: âœ… Release Summary
        run: |
          echo "ğŸ‰ Release v${{ steps.version.outputs.version }} created successfully!"
          echo ""
          echo "ğŸ“¦ Uploaded files:"
          ls -la release/
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
